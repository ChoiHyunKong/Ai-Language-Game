# 게임 랭킹 시스템 연동 가이드

## 1. Firestore 규칙 업데이트 필요

현재 Firestore 규칙이 업데이트되었습니다. Firebase Console에서 배포해야 합니다:

1. Firebase Console 접속: https://console.firebase.google.com/
2. 프로젝트 선택: ai-language-game
3. Firestore Database → Rules 탭
4. `firestore.rules` 파일 내용 복사 후 붙여넣기
5. "게시" 버튼 클릭

**변경 사항**: 게임 모드에 'word', 'meaning', 'sentence' 추가

## 2. 게임 코드에 랭킹 시스템 통합

### 2.1 게임 시작 시 - 세션 생성

게임이 시작될 때 세션을 생성해야 합니다. `js/main.js` 또는 게임 시작 로직에 추가:

```javascript
import { startGameSession, recordGameAction } from '../src/firebase/security.js';

// 게임 시작 버튼 클릭 시
document.getElementById('startBtn').addEventListener('click', () => {
    const mode = document.getElementById('gameModeSelect').value; // 'word', 'meaning', 'sentence'
    const difficulty = document.getElementById('difficultySelect').value;

    // 게임 세션 시작
    const gameSession = startGameSession({
        mode: mode,
        difficulty: difficulty
    });

    console.log('게임 세션 시작:', gameSession.sessionId);

    // 게임 시작...
});
```

### 2.2 플레이 중 - 액션 기록

사용자가 정답을 맞히거나 행동할 때마다 기록:

```javascript
import { getCurrentSession, recordGameAction, updateSession } from '../src/firebase/security.js';

// 정답 체크 함수 예시
function checkAnswer(userInput, correctAnswer, score) {
    const session = getCurrentSession();

    if (userInput === correctAnswer) {
        // 정답일 경우 액션 기록
        recordGameAction(session, {
            type: 'answer',
            data: { word: correctAnswer, correct: true },
            score: score
        });

        // 세션 업데이트
        updateSession(session);

        console.log('현재 점수:', session.score);
    } else {
        // 오답일 경우에도 기록 (점수 없음)
        recordGameAction(session, {
            type: 'answer',
            data: { word: userInput, correct: false },
            score: 0
        });
        updateSession(session);
    }
}
```

### 2.3 게임 종료 시 - 랭킹 제출

게임이 끝나면 결과 화면에서 랭킹 제출:

```javascript
import { getCurrentSession, submitRanking, endGameSession } from '../src/firebase/security.js';

// "기록 저장" 버튼 클릭 시
document.getElementById('submitScoreBtn').addEventListener('click', async () => {
    const playerName = document.getElementById('playerName').value.trim();

    if (!playerName) {
        alert('이름을 입력하세요!');
        return;
    }

    try {
        const session = getCurrentSession();

        // 랭킹 제출
        const docId = await submitRanking(playerName, session);

        console.log('랭킹 저장 완료:', docId);
        alert('랭킹이 저장되었습니다!');

        // 세션 종료
        endGameSession();

    } catch (error) {
        console.error('랭킹 저장 실패:', error);
        alert('랭킹 저장에 실패했습니다: ' + error.message);
    }
});
```

### 2.4 랭킹 조회

랭킹 버튼 클릭 시 랭킹 표시:

```javascript
import { fetchRankings } from '../src/firebase/security.js';

// "랭킹" 버튼 클릭 시
document.getElementById('rankingBtn').addEventListener('click', async () => {
    try {
        // 모든 모드의 전체 랭킹 조회
        const rankings = await fetchRankings('all', 'all');

        // 또는 특정 모드만 조회
        // const rankings = await fetchRankings('word', 'all');

        // 랭킹 표시
        displayRankings(rankings);

    } catch (error) {
        console.error('랭킹 조회 실패:', error);
    }
});

function displayRankings(rankings) {
    const rankingList = document.getElementById('rankingList');

    if (rankings.length === 0) {
        rankingList.innerHTML = '<div class="ranking-empty">기록이 없습니다</div>';
        return;
    }

    rankingList.innerHTML = rankings.map((rank, index) => `
        <div class="ranking-item">
            <span class="rank">${index + 1}</span>
            <span class="name">${rank.playerName}</span>
            <span class="score">${rank.score}점</span>
            <span class="mode">${getModeLabel(rank.mode)}</span>
        </div>
    `).join('');

    // 모달 표시
    document.getElementById('rankingModal').classList.remove('hidden');
}

function getModeLabel(mode) {
    const labels = {
        'word': '단어 연습',
        'meaning': '의미 퀴즈',
        'sentence': '문장 완성'
    };
    return labels[mode] || mode;
}
```

## 3. 보안 체크리스트

현재 구현된 보안 기능:

- ✅ 익명 인증 (Firebase Anonymous Auth)
- ✅ 세션 기반 검증 (sessionStorage)
- ✅ 액션 시퀀스 검증 (시간 순서, 간격 체크)
- ✅ 점수 해시 검증 (HMAC-SHA256)
- ✅ 시간당 최대 점수 제한 (초당 100점)
- ✅ Firestore 서버 규칙 검증
- ✅ 스팸 방지 (30초 쿨다운)

## 4. 테스트 방법

### 정상 플레이 테스트

1. 게임 시작
2. 정답 3-5개 입력
3. 게임 종료
4. 이름 입력 후 "기록 저장"
5. 랭킹 확인

### 비정상 플레이 테스트 (방어 확인)

1. **너무 빠른 점수**: 게임 시작 후 즉시 높은 점수로 제출
   - 예상: "점수가 이론적 최대치를 초과했습니다" 에러

2. **스팸**: 30초 내에 여러 번 제출
   - 예상: Firestore 규칙에서 차단

3. **잘못된 모드**: 존재하지 않는 게임 모드로 제출
   - 예상: Firestore 규칙에서 차단

## 5. 다음 단계

1. ✅ Firestore 규칙 업데이트 배포
2. 🔄 게임 코드에 랭킹 시스템 통합 (위 가이드 참고)
3. ⏳ 실제 게임으로 테스트
4. ⏳ 랭킹 UI 개선 (필요시)
5. ⏳ SEO 최적화
6. ⏳ Vercel 배포

## 6. 문제 해결

### 문제: "Missing or insufficient permissions"

**원인**:
- Firestore 규칙이 배포되지 않음
- 게임 모드가 규칙에서 허용하지 않는 값

**해결**:
1. Firebase Console에서 최신 규칙 배포 확인
2. 콘솔에서 제출된 데이터 확인: `console.log(rankingData)`
3. mode 값이 허용된 값인지 확인

### 문제: "점수 검증 실패"

**원인**: 액션 기록이 올바르지 않음

**해결**:
1. 각 정답마다 `recordGameAction()` 호출 확인
2. 점수 계산이 액션 점수 합계와 일치하는지 확인
3. 콘솔에서 세션 데이터 확인: `console.log(getCurrentSession())`

### 문제: "인증되지 않은 사용자"

**원인**: Firebase 인증이 완료되지 않음

**해결**:
1. `main.js`에서 `authenticateUser()` 호출 확인
2. 인증 완료 후 게임 시작 활성화
3. 브라우저 콘솔에서 인증 상태 확인
